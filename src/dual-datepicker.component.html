<div class="datepicker-wrapper" 
  [style.--input-border-hover]="inputBorderColorHover"
  [style.--input-border-focus]="inputBorderColorFocus">
  <input 
    type="text" 
    class="datepicker-input" 
    [value]="dateRangeText()" 
    (click)="toggleDatePicker()" 
    [placeholder]="placeholder"
    [disabled]="isDisabled()"
    [attr.aria-label]="placeholder"
    [attr.aria-expanded]="showDatePicker()"
    [attr.aria-haspopup]="'dialog'"
    role="combobox"
    [ngStyle]="{
      'background-color': inputBackgroundColor,
      'color': inputTextColor,
      'border-color': inputBorderColor,
      'padding': inputPadding
    }"
    readonly>

  @if (showDatePicker()) {
  <div class="date-picker-dropdown">
    @if (showPresets) {
    <div class="date-picker-presets">
      @for (preset of presets; track preset.label) {
      <button type="button" (click)="selectPresetRange(preset)">{{ preset.label }}</button>
      }
      <button type="button" class="btn-close-calendar" (click)="closeDatePicker()" title="Close">
        ×
      </button>
    </div>
    }

    @if (!showPresets) {
    <div class="date-picker-header-only-close">
      <button type="button" class="btn-close-calendar" (click)="closeDatePicker()" title="Close">
        ×
      </button>
    </div>
    }

    <!-- Calendars -->
    <div class="date-picker-calendars">
      <!-- Previous month calendar -->
      <div class="date-picker-calendar">
        <div class="date-picker-header">
          <button type="button" (click)="changeMonth(-1)">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/>
            </svg>
          </button>
          <span>{{ previousMonthName() }}</span>
          <button type="button" style="visibility: hidden;">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
            </svg>
          </button>
        </div>
        <div class="date-picker-weekdays">
          @for (dayName of weekDayNames(); track $index) {
            <span>{{ dayName }}</span>
          }
        </div>
        <div class="date-picker-days">
          @for (dayObj of previousMonthDays(); track dayObj.date || $index) {
            <button 
              type="button"
              class="date-picker-day" 
              [class.empty]="!dayObj.isCurrentMonth"
              [class.selected]="dayObj.isStart || dayObj.isEnd"
              [class.in-range]="dayObj.inRange && !dayObj.isStart && !dayObj.isEnd"
              [class.keyboard-focused]="hasKeyboardFocus(dayObj.date, 0)"
              [attr.tabindex]="dayObj.isCurrentMonth && hasKeyboardFocus(dayObj.date, 0) ? 0 : -1"
              [attr.aria-label]="formatDateDisplay(dayObj.date)"
              [attr.aria-selected]="dayObj.isStart || dayObj.isEnd"
              [attr.aria-current]="dayObj.isStart ? 'date' : null"
              (click)="selectDay(dayObj)"
              [disabled]="!dayObj.isCurrentMonth">
              {{ dayObj.day }}
            </button>
          }
        </div>
      </div>

      <!-- Current month calendar -->
      <div class="date-picker-calendar">
        <div class="date-picker-header">
          <button type="button" style="visibility: hidden;">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/>
            </svg>
          </button>
          <span>{{ currentMonthName() }}</span>
          <button type="button" (click)="changeMonth(1)">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
            </svg>
          </button>
        </div>
        <div class="date-picker-weekdays">
          @for (dayName of weekDayNames(); track $index) {
            <span>{{ dayName }}</span>
          }
        </div>
        <div class="date-picker-days">
          @for (dayObj of currentMonthDays(); track dayObj.date || $index) {
            <button 
              type="button"
              class="date-picker-day" 
              [class.empty]="!dayObj.isCurrentMonth"
              [class.selected]="dayObj.isStart || dayObj.isEnd"
              [class.in-range]="dayObj.inRange && !dayObj.isStart && !dayObj.isEnd"
              [class.keyboard-focused]="hasKeyboardFocus(dayObj.date, 1)"
              [attr.tabindex]="dayObj.isCurrentMonth && hasKeyboardFocus(dayObj.date, 1) ? 0 : -1"
              [attr.aria-label]="formatDateDisplay(dayObj.date)"
              [attr.aria-selected]="dayObj.isStart || dayObj.isEnd"
              [attr.aria-current]="dayObj.isStart ? 'date' : null"
              (click)="selectDay(dayObj)"
              [disabled]="!dayObj.isCurrentMonth">
              {{ dayObj.day }}
            </button>
          }
        </div>
      </div>
    </div>

    <!-- Multi-Range List -->
    @if (multiRange && selectedRanges().length > 0) {
    <div class="multi-range-list">
      <div class="multi-range-header">
        <span class="multi-range-title">Selected Ranges ({{ selectedRanges().length }})</span>
      </div>
      <div class="multi-range-items">
        @for (range of selectedRanges(); track $index) {
        <div class="multi-range-item">
          <span class="multi-range-text">{{ range.rangeText }}</span>
          <button 
            type="button" 
            class="btn-remove-range" 
            (click)="removeRange($index)"
            title="Remove this range">
            <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
              <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
            </svg>
          </button>
        </div>
        }
      </div>
    </div>
    }

    <!-- Footer with clear button -->
    @if (showClearButton || multiRange) {
    <div class="date-picker-footer">
      @if (multiRange) {
        <div class="multi-range-footer-actions">
          <button type="button" class="btn-clear" (click)="clear()" title="Clear all ranges">
            Clear All
          </button>
          <button type="button" class="btn-done" (click)="closeDatePicker()" title="Done selecting">
            Done
          </button>
        </div>
      }
      @if (!multiRange && showClearButton) {
        <button type="button" class="btn-clear" (click)="clear()" title="Clear selection">
          Clear
        </button>
      }
    </div>
    }
  </div>
  }
</div>
